---
plan: 02-04
title: Configure Sanity Client and GROQ Helpers
phase: 2
wave: 2
depends_on:
  - 02-01
files_modified:
  - sanity/lib/client.ts
  - sanity/lib/queries.ts
  - sanity/lib/image.ts
autonomous: true
---

# Plan 02-04: Configure Sanity Client and GROQ Helpers

## Objective
Set up the Sanity client for data fetching, create reusable GROQ queries for all content types, and configure the image URL builder for optimized image delivery.

## must_haves
- Sanity client configured with project credentials
- CDN enabled for production, disabled for development previews
- API version pinned to specific date
- GROQ queries for siteSettings, pages, and teamMembers
- Image URL builder configured and ready for use
- TypeScript-friendly query definitions using `defineQuery`

## Tasks

<task id="1">
**Create Sanity client**

Create `sanity/lib/client.ts`:

```typescript
import { createClient } from 'next-sanity'

export const client = createClient({
  projectId: process.env.NEXT_PUBLIC_SANITY_PROJECT_ID!,
  dataset: process.env.NEXT_PUBLIC_SANITY_DATASET!,
  apiVersion: '2024-01-01', // Pin to specific date for stability
  useCdn: process.env.NODE_ENV === 'production', // CDN for production, fresh data for dev
})

// For authenticated requests (server-only, e.g., draft content)
export const writeClient = createClient({
  projectId: process.env.NEXT_PUBLIC_SANITY_PROJECT_ID!,
  dataset: process.env.NEXT_PUBLIC_SANITY_DATASET!,
  apiVersion: '2024-01-01',
  useCdn: false,
  token: process.env.SANITY_API_TOKEN, // Only available server-side
})
```

Configuration notes:
- `apiVersion`: Pinned to specific date to avoid breaking changes
- `useCdn: true` in production for faster cached responses
- `useCdn: false` in development for latest content
- `writeClient` for server-only operations requiring authentication
</task>

<task id="2" depends_on="1">
**Create GROQ queries**

Create `sanity/lib/queries.ts`:

```typescript
import { defineQuery } from 'next-sanity'

// ==========================================
// Site Settings (Singleton)
// ==========================================

export const siteSettingsQuery = defineQuery(`
  *[_type == "siteSettings"][0] {
    siteName,
    siteDescription,
    contactEmail,
    socialLinks,
    "logoUrl": logo.asset->url
  }
`)

// ==========================================
// Pages
// ==========================================

// All pages (for navigation/sitemap)
export const allPagesQuery = defineQuery(`
  *[_type == "page"] | order(title asc) {
    _id,
    title,
    "slug": slug.current
  }
`)

// Single page by slug
export const pageBySlugQuery = defineQuery(`
  *[_type == "page" && slug.current == $slug][0] {
    _id,
    title,
    "slug": slug.current,
    heroText,
    "heroImage": heroImage {
      asset->,
      hotspot,
      crop
    },
    content,
    seo {
      metaTitle,
      metaDescription,
      "ogImageUrl": ogImage.asset->url
    }
  }
`)

// Page slugs for static generation
export const pageSlugsQuery = defineQuery(`
  *[_type == "page" && defined(slug.current)][].slug.current
`)

// ==========================================
// Team Members
// ==========================================

// All team members (grouped by role)
export const allTeamMembersQuery = defineQuery(`
  {
    "dirigenten": *[_type == "teamMember" && role == "dirigent"] | order(order asc) {
      _id,
      name,
      choir,
      bio,
      "photoUrl": photo.asset->url,
      "photo": photo {
        asset->,
        hotspot,
        crop
      }
    },
    "bestuur": *[_type == "teamMember" && role == "bestuur"] | order(order asc) {
      _id,
      name,
      boardPosition,
      bio,
      "photoUrl": photo.asset->url,
      "photo": photo {
        asset->,
        hotspot,
        crop
      }
    },
    "begeleiders": *[_type == "teamMember" && role == "begeleider"] | order(order asc) {
      _id,
      name,
      choir,
      bio,
      "photoUrl": photo.asset->url,
      "photo": photo {
        asset->,
        hotspot,
        crop
      }
    }
  }
`)

// Team members by role
export const teamMembersByRoleQuery = defineQuery(`
  *[_type == "teamMember" && role == $role] | order(order asc) {
    _id,
    name,
    role,
    choir,
    boardPosition,
    bio,
    "photoUrl": photo.asset->url,
    "photo": photo {
      asset->,
      hotspot,
      crop
    }
  }
`)

// Single team member by ID (for detail pages if needed)
export const teamMemberByIdQuery = defineQuery(`
  *[_type == "teamMember" && _id == $id][0] {
    _id,
    name,
    role,
    choir,
    boardPosition,
    bio,
    "photoUrl": photo.asset->url,
    "photo": photo {
      asset->,
      hotspot,
      crop
    }
  }
`)
```

Query design notes:
- Use explicit field projections (never `*[_type == "x"]` without fields)
- Dereference images in query: `photo.asset->url`
- Include hotspot/crop data for proper image cropping
- Use `defineQuery` for TypeScript type generation compatibility
</task>

<task id="3" depends_on="1">
**Create image URL builder**

Create `sanity/lib/image.ts`:

```typescript
import imageUrlBuilder from '@sanity/image-url'
import type { SanityImageSource } from '@sanity/image-url/lib/types/types'
import { client } from './client'

const builder = imageUrlBuilder(client)

/**
 * Generate optimized image URLs from Sanity image objects
 *
 * @example
 * // Basic usage
 * urlFor(image).width(800).url()
 *
 * // With auto-format and quality
 * urlFor(image).width(800).height(600).auto('format').quality(80).url()
 *
 * // For portraits with hotspot
 * urlFor(image).width(400).height(400).fit('crop').url()
 */
export function urlFor(source: SanityImageSource) {
  return builder.image(source)
}

/**
 * Generate a blurred placeholder URL for lazy loading
 * Returns a tiny blurred version of the image
 */
export function blurUrlFor(source: SanityImageSource) {
  return builder.image(source).width(24).height(24).blur(10).url()
}

/**
 * Common image presets for consistent sizing across the site
 */
export const imagePresets = {
  // Hero images (full width)
  hero: (source: SanityImageSource) =>
    urlFor(source).width(1920).height(800).auto('format').quality(85).url(),

  // Team member photos (square)
  avatar: (source: SanityImageSource) =>
    urlFor(source).width(400).height(400).fit('crop').auto('format').quality(80).url(),

  // Thumbnail for lists
  thumbnail: (source: SanityImageSource) =>
    urlFor(source).width(200).height(200).fit('crop').auto('format').quality(75).url(),

  // Card images
  card: (source: SanityImageSource) =>
    urlFor(source).width(600).height(400).fit('crop').auto('format').quality(80).url(),

  // Open Graph / social sharing
  og: (source: SanityImageSource) =>
    urlFor(source).width(1200).height(630).fit('crop').auto('format').quality(80).url(),
}
```

Image helper features:
- `urlFor()` - Flexible builder for any size/format
- `blurUrlFor()` - Generate blur placeholder for lazy loading
- `imagePresets` - Consistent sizing across the site
- Auto-format enabled (AVIF/WebP when supported)
</task>

<task id="4" depends_on="1,2,3">
**Create lib barrel export (optional)**

Create `sanity/lib/index.ts` for convenient imports:

```typescript
export { client, writeClient } from './client'
export { urlFor, blurUrlFor, imagePresets } from './image'
export * from './queries'
```

This allows importing like:
```typescript
import { client, siteSettingsQuery, urlFor } from '@/sanity/lib'
```
</task>

<task id="5" depends_on="4">
**Test client connectivity**

Create a quick test to verify the client works. In a terminal:

```bash
npx tsx -e "
const { createClient } = require('next-sanity');
const client = createClient({
  projectId: process.env.NEXT_PUBLIC_SANITY_PROJECT_ID,
  dataset: process.env.NEXT_PUBLIC_SANITY_DATASET,
  apiVersion: '2024-01-01',
  useCdn: false,
});
client.fetch('*[_type == \"siteSettings\"][0]').then(console.log).catch(console.error);
"
```

Or test in a page component (temporary):

```typescript
// In app/page.tsx (temporary test)
import { client } from '@/sanity/lib/client'

export default async function HomePage() {
  const test = await client.fetch('*[_type == "siteSettings"][0]')
  console.log('Sanity test:', test) // Will be null if no content yet
  return <div>Check console</div>
}
```
</task>

## Verification

1. **File existence:**
   - `sanity/lib/client.ts` exists
   - `sanity/lib/queries.ts` exists
   - `sanity/lib/image.ts` exists
   - `sanity/lib/index.ts` exists (optional)

2. **TypeScript check:**
   ```bash
   npx tsc --noEmit
   ```
   No errors in sanity/lib files.

3. **Client connectivity test:**
   - Import client in a page
   - Fetch returns data (or null if no content)
   - No authentication errors
   - No CORS errors in browser console

4. **Query syntax:**
   - All queries use explicit field projections
   - Images are dereferenced (`asset->url`)
   - Parameterized queries use `$param` syntax

5. **Image URL builder:**
   ```typescript
   import { urlFor } from '@/sanity/lib/image'
   // Test that it generates valid URL format:
   // https://cdn.sanity.io/images/{projectId}/{dataset}/{imageId}.jpg?w=800
   ```
